#!/usr/bin/env php
<?php
require_once dirname(__FILE__) . '/../lib/Application.php';
Horde_Registry::appInit('lab', array('authentication' => 'none'));

$request_url = 'http://www.advancedlubes.com/pib/user/login';

// User data
$user_data = $GLOBALS['conf']['drupal'];
$user_data = http_build_query($user_data);

// cURL
$curl = curl_init($request_url);
curl_setopt($curl, CURLOPT_HTTPHEADER, array('Accept: application/json')); // Accept JSON response
curl_setopt($curl, CURLOPT_POST, 1); // Do a regular HTTP POST
curl_setopt($curl, CURLOPT_POSTFIELDS, $user_data); // Set POST data
curl_setopt($curl, CURLOPT_HEADER, FALSE);  // Ask to not return Header
curl_setopt($curl, CURLOPT_RETURNTRANSFER, TRUE);
curl_setopt($curl, CURLOPT_FAILONERROR, TRUE);

$response = curl_exec($curl);
$http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);

// Check if login was successful
if ($http_code == 200) {
    // Convert json response as array
    $logged_user = json_decode($response);
    $cookie_session = $logged_user->session_name . '=' . $logged_user->sessid;
}
else {
    // Get error msg
    print_r($response);
    $http_message = curl_error($curl);
    die($http_message);
}

$products = $GLOBALS['injector']->getInstance('Lab_Driver')->listProducts();

foreach ($products as $product) {
    $spec = $GLOBALS['injector']->getInstance('Lab_Driver')->getProductSpecs($product['name']);
    $request_url = "http://www.advancedlubes.com/pib/node/$product[drupal_node]";
    $node_data = array(
        'title' => 'A node created with services 3.x and REST server',
        'type' => 'page',
        'body[und][0][value]' => '<p>Body</p>',
    );
    $node_data = http_build_query($node_data);

    // cURL
    $curl = curl_init($request_url);
    curl_setopt($curl, CURLOPT_HTTPHEADER, array('Accept: application/json')); // Accept JSON response
    curl_setopt($curl, CURLOPT_POST, 1); // Do a regular HTTP POST
    curl_setopt($curl, CURLOPT_POSTFIELDS, $node_data); // Set POST data
    curl_setopt($curl, CURLOPT_HEADER, FALSE);  // Ask to not return Header
    curl_setopt($curl, CURLOPT_COOKIE, "$cookie_session"); // use the previously saved session
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, TRUE);
    curl_setopt($curl, CURLOPT_FAILONERROR, TRUE);

    $response = curl_exec($curl);
    $http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);

    // Check if login was successful
    if ($http_code == 200) {
        // Convert json response as array
        $node = json_decode($response);
    } else {
        // Get error msg
        $http_message = curl_error($curl);
        die($http_message);
    }
}

?>


